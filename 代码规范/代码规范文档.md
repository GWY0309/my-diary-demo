# 代码规范文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述了私人日记App - My Diary项目的代码规范和最佳实践，包括Dart语言规范、Flutter开发规范、命名规范、代码结构、注释规范、测试规范等内容。旨在确保团队成员编写的代码具有一致性、可读性和可维护性，提高团队协作效率和代码质量。

### 1.2 文档范围
本文档适用于My Diary项目的所有开发人员，包括前端开发人员和后端开发人员。文档覆盖了项目中使用的Dart语言和Flutter框架的代码规范，适用于项目的所有代码文件和模块。

### 1.3 术语定义
| 术语 | 定义 |
|------|------|
| Dart | Google开发的面向对象、类定义、单继承的编程语言，用于开发跨平台应用 |
| Flutter | Google开发的开源UI软件开发工具包，用于开发跨平台应用 |
| Widget | Flutter中的UI组件，是构建UI的基本单位 |
| State | Flutter中的状态管理类，用于管理Widget的状态 |
| BLoC | Business Logic Component，一种Flutter状态管理模式 |
| Provider | Flutter中的状态管理库，用于在Widget树中共享状态 |
| Widget Tree | Flutter中的UI组件树，用于构建应用界面 |
| Element Tree | Flutter中的元素树，用于管理Widget的状态和生命周期 |
| Render Tree | Flutter中的渲染树，用于渲染UI界面 |

## 2. 编码风格

### 2.1 Dart语言规范
- 遵循Dart官方的编码风格指南：[Dart Style Guide](https://dart.dev/guides/language/effective-dart/style)
- 使用Dart 3.0+版本，充分利用空安全特性
- 保持代码简洁、清晰，避免冗余代码
- 优先使用不可变数据结构

### 2.2 文件命名规范
- 文件名称使用小写字母，单词之间用下划线分隔（snake_case）
- 文件名应具有描述性，反映文件的内容和功能
- 示例：
  - 正确：`user_service.dart`、`diary_list_screen.dart`、`theme_provider.dart`
  - 错误：`UserService.dart`、`DiaryListScreen.dart`、`ThemeProvider.dart`

### 2.3 目录结构规范
- 遵循Flutter项目的标准目录结构
- 功能模块按照业务逻辑进行划分，每个模块有独立的目录
- 示例：
  ```
  lib/
  ├── main.dart                # 应用入口文件
  ├── models/                  # 数据模型层
  │   ├── user.dart           # 用户模型
  │   ├── diary.dart          # 日记模型
  │   └── tag.dart            # 标签模型
  ├── services/               # 服务层
  │   ├── user_service.dart   # 用户服务
  │   ├── diary_service.dart  # 日记服务
  │   └── tag_service.dart    # 标签服务
  ├── screens/                # 界面层
  │   ├── auth/               # 认证相关界面
  │   │   ├── login_screen.dart
  │   │   └── register_screen.dart
  │   ├── diary/              # 日记相关界面
  │   │   ├── diary_list_screen.dart
  │   │   ├── diary_detail_screen.dart
  │   │   └── diary_edit_screen.dart
  │   └── settings/           # 设置相关界面
  │       └── settings_screen.dart
  ├── widgets/                # 自定义组件
  │   ├── diary_card.dart     # 日记卡片组件
  │   └── tag_chip.dart       # 标签芯片组件
  ├── providers/              # 状态管理
  │   ├── user_provider.dart  # 用户状态管理
  │   └── theme_provider.dart # 主题状态管理
  ├── utils/                  # 工具类
  │   ├── encryption.dart     # 加密工具
  │   └── date_format.dart    # 日期格式化工具
  └── constants/              # 常量定义
      ├── colors.dart         # 颜色常量
      └── routes.dart         # 路由常量
  ```

## 3. 命名规范

### 3.1 类命名
- 使用大驼峰命名法（PascalCase），首字母大写
- 类名应具有描述性，反映类的功能和用途
- 避免使用缩写，除非缩写是广为人知的（如UI、API等）
- 示例：
  - 正确：`UserService`、`DiaryListScreen`、`ThemeProvider`
  - 错误：`userService`、`diary_list_screen`、`theme_provider`

### 3.2 方法命名
- 使用小驼峰命名法（camelCase），首字母小写
- 方法名应具有描述性，动词开头，反映方法的功能
- 示例：
  - 正确：`getUserInfo()`、`createDiary()`、`updateTheme()`
  - 错误：`GetUserInfo()`、`create_diary()`、`UpdateTheme()`

### 3.3 变量命名
- 使用小驼峰命名法（camelCase），首字母小写
- 变量名应具有描述性，反映变量的含义和用途
- 避免使用单字母变量名（如i、j、k等），除非在循环中使用
- 示例：
  - 正确：`userName`、`diaryContent`、`isDarkTheme`
  - 错误：`user_name`、`diarycontent`、`isdarktheme`

### 3.4 常量命名
- 使用全大写字母，单词之间用下划线分隔（UPPER_SNAKE_CASE）
- 常量名应具有描述性，反映常量的含义和用途
- 示例：
  - 正确：`API_URL`、`MAX_CONTENT_LENGTH`、`DEFAULT_THEME`
  - 错误：`apiUrl`、`maxContentLength`、`defaultTheme`

### 3.5 枚举命名
- 枚举类使用大驼峰命名法（PascalCase）
- 枚举值使用大驼峰命名法（PascalCase）
- 示例：
  ```dart
  enum DiaryStatus {
    draft,
    published,
    archived,
  }
  ```

### 3.6 参数命名
- 使用小驼峰命名法（camelCase），首字母小写
- 参数名应具有描述性，反映参数的含义和用途
- 示例：
  ```dart
  void createDiary(String title, String content, List<String> tags) {
    // 实现代码
  }
  ```

## 4. 代码结构

### 4.1 导入规范
- 导入顺序：Dart核心库 → Flutter库 → 第三方库 → 项目内部库
- 不同类别的导入之间使用空行分隔
- 使用相对路径导入项目内部库
- 避免使用`as`关键字重命名导入，除非有命名冲突
- 示例：
  ```dart
  // Dart核心库
  import 'dart:convert';
  import 'dart:io';
  
  // Flutter库
  import 'package:flutter/material.dart';
  import 'package:flutter/services.dart';
  import 'package:flutter_bloc/flutter_bloc.dart';
  
  // 第三方库
  import 'package:firebase_auth/firebase_auth.dart';
  import 'package:cloud_firestore/cloud_firestore.dart';
  
  // 项目内部库
  import '../models/diary.dart';
  import '../services/diary_service.dart';
  import '../widgets/diary_card.dart';
  ```

### 4.2 类结构
- 类的成员顺序：构造函数 → 静态方法 → 公共方法 → 私有方法 → 公共属性 → 私有属性
- 使用`_`前缀表示私有成员
- 示例：
  ```dart
  class DiaryService {
    // 构造函数
    DiaryService();
    
    // 静态方法
    static DiaryService getInstance() {
      return DiaryService();
    }
    
    // 公共方法
    Future<List<Diary>> getDiaries() async {
      // 实现代码
    }
    
    Future<Diary> getDiaryById(String id) async {
      // 实现代码
    }
    
    Future<void> createDiary(Diary diary) async {
      // 实现代码
    }
    
    // 私有方法
    Future<QuerySnapshot> _queryDiaries() async {
      // 实现代码
    }
    
    // 公共属性
    final String collectionName = 'diaries';
    
    // 私有属性
    final FirebaseFirestore _firestore = FirebaseFirestore.instance;
  }
  ```

### 4.3 Widget结构
- 遵循Flutter的Widget树结构
- 拆分复杂Widget为多个简单Widget
- 使用Builder模式构建复杂Widget
- 示例：
  ```dart
  class DiaryListScreen extends StatelessWidget {
    @override
    Widget build(BuildContext context) {
      return Scaffold(
        appBar: AppBar(
          title: Text('我的日记'),
          actions: [
            IconButton(
              icon: Icon(Icons.settings),
              onPressed: () {
                // 导航到设置页面
              },
            ),
          ],
        ),
        body: Container(
          padding: EdgeInsets.all(16.0),
          child: FutureBuilder<List<Diary>>(
            future: DiaryService.getInstance().getDiaries(),
            builder: (context, snapshot) {
              if (snapshot.hasData) {
                return ListView.builder(
                  itemCount: snapshot.data!.length,
                  itemBuilder: (context, index) {
                    return DiaryCard(diary: snapshot.data![index]);
                  },
                );
              } else if (snapshot.hasError) {
                return Center(
                  child: Text('加载失败: ${snapshot.error}'),
                );
              } else {
                return Center(
                  child: CircularProgressIndicator(),
                );
              }
            },
          ),
        ),
        floatingActionButton: FloatingActionButton(
          child: Icon(Icons.add),
          onPressed: () {
            // 导航到日记编辑页面
          },
        ),
      );
    }
  }
  ```

## 5. 注释规范

### 5.1 注释原则
- 注释应简洁、清晰，反映代码的功能和意图
- 避免冗余注释，不要注释显而易见的代码
- 更新代码时，同步更新相关注释
- 使用英文注释，保持一致性

### 5.2 类注释
- 使用文档注释（///）描述类的功能、用途和主要方法
- 示例：
  ```dart
  /// 用户服务类，提供用户相关的业务逻辑
  /// 
  /// 包括用户注册、登录、获取用户信息等功能
  /// 使用Firebase Auth进行用户认证
  class UserService {
    // 类实现
  }
  ```

### 5.3 方法注释
- 使用文档注释（///）描述方法的功能、参数、返回值和异常
- 示例：
  ```dart
  /// 获取日记列表
  /// 
  /// [userId]：用户ID，用于筛选该用户的日记
  /// [startDate]：开始日期，用于筛选指定日期范围的日记
  /// [endDate]：结束日期，用于筛选指定日期范围的日记
  /// 
  /// 返回值：日记列表
  /// 
  /// 异常：当获取日记失败时抛出
  Future<List<Diary>> getDiaries({
    required String userId,
    DateTime? startDate,
    DateTime? endDate,
  }) async {
    // 实现代码
  }
  ```

### 5.4 代码块注释
- 使用单行注释（//）或多行注释（/* */）描述代码块的功能
- 示例：
  ```dart
  // 初始化Firebase服务
  Firebase.initializeApp();
  
  /*
   * 配置应用主题
   * 包括颜色、字体、边距等
   */
  final ThemeData lightTheme = ThemeData(
    primaryColor: Colors.blue,
    accentColor: Colors.green,
    brightness: Brightness.light,
  );
  ```

### 5.5 变量注释
- 使用单行注释（//）描述变量的含义和用途
- 示例：
  ```dart
  // 用户ID
  final String userId = FirebaseAuth.instance.currentUser!.uid;
  
  // 日记内容最大长度
  final int maxContentLength = 10000;
  ```

## 6. 代码质量

### 6.1 代码简洁性
- 避免冗余代码，保持代码简洁
- 使用Dart的语法糖和便捷方法
- 示例：
  ```dart
  // 正确：使用空安全和可选链
  final String? userName = user?.name;
  
  // 错误：冗余的空检查
  String? userName;
  if (user != null) {
    userName = user.name;
  } else {
    userName = null;
  }
  ```

### 6.2 代码可读性
- 保持适当的缩进和换行
- 使用空格分隔运算符和操作数
- 避免过长的代码行（建议不超过80个字符）
- 示例：
  ```dart
  // 正确：适当的缩进和换行
  Future<void> createDiary(Diary diary) async {
    try {
      await _firestore.collection(collectionName).add(
        diary.toMap(),
      );
    } catch (e) {
      throw Exception('创建日记失败: $e');
    }
  }
  
  // 错误：过长的代码行和缺乏缩进
  Future<void> createDiary(Diary diary) async { try { await _firestore.collection(collectionName).add(diary.toMap()); } catch (e) { throw Exception('创建日记失败: $e'); } }
  ```

### 6.3 错误处理
- 使用try-catch块捕获异常
- 提供有意义的错误信息
- 避免空异常
- 示例：
  ```dart
  // 正确：使用try-catch处理异常
  Future<void> login(String email, String password) async {
    try {
      await FirebaseAuth.instance.signInWithEmailAndPassword(
        email: email,
        password: password,
      );
    } on FirebaseAuthException catch (e) {
      if (e.code == 'user-not-found') {
        throw Exception('用户不存在');
      } else if (e.code == 'wrong-password') {
        throw Exception('密码错误');
      } else {
        throw Exception('登录失败: ${e.message}');
      }
    } catch (e) {
      throw Exception('登录失败: $e');
    }
  }
  
  // 错误：没有错误处理
  Future<void> login(String email, String password) async {
    await FirebaseAuth.instance.signInWithEmailAndPassword(
      email: email,
      password: password,
    );
  }
  ```

### 6.4 性能优化
- 避免不必要的重建和重绘
- 使用const构造函数创建不可变Widget
- 使用ListView.builder()代替ListView()渲染长列表
- 使用FutureBuilder和StreamBuilder时提供initialData
- 示例：
  ```dart
  // 正确：使用const构造函数
  const Text('我的日记');
  
  // 正确：使用ListView.builder()渲染长列表
  ListView.builder(
    itemCount: diaryList.length,
    itemBuilder: (context, index) {
      return DiaryCard(diary: diaryList[index]);
    },
  );
  
  // 正确：提供initialData
  FutureBuilder<List<Diary>>(
    future: DiaryService.getInstance().getDiaries(),
    initialData: [],
    builder: (context, snapshot) {
      // 实现代码
    },
  );
  ```

## 7. 测试规范

### 7.1 测试类型
- 单元测试：测试最小可测试单元
- 集成测试：测试模块间的交互
- 小部件测试：测试Flutter Widget的功能

### 7.2 测试文件命名
- 测试文件与被测试文件同名，后缀为_test.dart
- 示例：
  - 被测试文件：`user_service.dart`
  - 测试文件：`user_service_test.dart`

### 7.3 测试目录结构
- 测试文件与被测试文件放在同一目录下
- 示例：
  ```
  lib/
  ├── services/
  │   ├── user_service.dart
  │   └── user_service_test.dart
  └── widgets/
      ├── diary_card.dart
      └── diary_card_test.dart
  ```

### 7.4 测试代码规范
- 使用`test`或`group`函数定义测试
- 使用`expect`函数验证测试结果
- 测试函数名应具有描述性，反映测试的功能
- 示例：
  ```dart
  import 'package:test/test.dart';
  import 'package:my_diary/services/user_service.dart';
  
  void main() {
    group('UserService', () {
      test('getUserInfo should return user information', () async {
        // 准备测试数据
        final String userId = 'test_user_id';
        
        // 执行测试
        final userInfo = await UserService.getInstance().getUserInfo(userId);
        
        // 验证结果
        expect(userInfo, isNotNull);
        expect(userInfo!.id, equals(userId));
      });
      
      test('login should throw exception for invalid credentials', () async {
        // 准备测试数据
        final String email = 'invalid@example.com';
        final String password = 'invalid_password';
        
        // 执行测试并验证结果
        expect(
          UserService.getInstance().login(email, password),
          throwsException,
        );
      });
    });
  }
  ```

## 8. 版本控制

### 8.1 Git规范
- 使用Git进行版本控制
- 遵循以下Git工作流程：
  1. 从develop分支创建功能分支（feature/*）
  2. 在功能分支上开发和测试
  3. 提交代码到功能分支
  4. 发起Pull Request到develop分支
  5. 代码评审通过后合并到develop分支

### 8.2 提交信息规范
- 提交信息应简洁、清晰，反映提交的内容
- 使用以下格式：
  ```
  <类型>: <描述>
  
  <详细说明>
  ```
- 类型包括：
  - feat：新功能
  - fix：Bug修复
  - docs：文档更新
  - style：代码风格调整
  - refactor：代码重构
  - test：测试代码更新
  - chore：构建或工具更新
- 示例：
  ```
  feat: 添加日记编辑功能
  
  - 实现日记内容编辑
  - 支持富文本格式
  - 添加图片上传功能
  ```

## 9. 代码审查

### 9.1 审查目的
- 提高代码质量
- 确保代码符合规范
- 发现潜在问题和缺陷
- 促进知识共享和团队协作

### 9.2 审查流程
1. 开发人员完成功能开发并提交代码
2. 发起Pull Request
3. 团队成员进行代码审查
4. 提出修改意见和建议
5. 开发人员修改代码
6. 代码审查通过后合并代码

### 9.3 审查要点
- 代码是否符合规范
- 代码质量和可读性
- 错误处理是否完善
- 性能是否优化
- 测试是否充分
- 潜在的安全问题

## 10. 工具和插件

### 10.1 开发工具
- Android Studio：Flutter开发环境
- VS Code：轻量级代码编辑器

### 10.2 插件推荐
- Flutter：Flutter开发支持
- Dart：Dart语言支持
- Flutter Outline：Flutter Widget树可视化
- Flutter Inspector：Flutter界面调试工具
- GitLens：Git版本控制增强
- Pubspec Assist：Dart包管理增强

### 10.3 代码分析工具
- dartanalyzer：Dart代码分析器
- flutter analyze：Flutter代码分析器
- pedantic：Dart代码规范检查
- effective_dart：Dart最佳实践检查

## 11. 附录

### 11.1 代码模板

#### 11.1.1 类模板
```dart
/// <类描述>
class <类名> {
  // 构造函数
  <类名>({<参数列表>});
  
  // 静态方法
  static <返回类型> <方法名>({<参数列表>}) {
    // 实现代码
  }
  
  // 公共方法
  <返回类型> <方法名>({<参数列表>}) {
    // 实现代码
  }
  
  // 私有方法
  <返回类型> _<方法名>({<参数列表>}) {
    // 实现代码
  }
  
  // 公共属性
  final <类型> <属性名> = <值>;
  
  // 私有属性
  final <类型> _<属性名> = <值>;
}
```

#### 11.1.2 Widget模板
```dart
/// <Widget描述>
class <Widget名> extends <Widget类型> {
  // 构造函数
  const <Widget名>({
    Key? key,
    required this.<参数名>,
    this.<可选参数名>,
  }) : super(key: key);
  
  // 参数
  final <类型> <参数名>;
  final <类型> <可选参数名>?;
  
  @override
  Widget build(BuildContext context) {
    return <Widget树>;
  }
}
```

#### 11.1.3 测试模板
```dart
import 'package:test/test.dart';
import 'package:my_diary/<被测试文件路径>';

void main() {
  group('<被测试类名>', () {
    test('<测试描述>', () async {
      // 准备测试数据
      
      // 执行测试
      
      // 验证结果
      expect(<实际结果>, <预期结果>);
    });
  });
}
```

### 11.2 常见问题

#### 11.2.1 代码规范检查
- 使用`flutter analyze`命令检查代码规范
- 修复所有警告和错误
- 示例：
  ```bash
  flutter analyze
  ```

#### 11.2.2 代码格式化
- 使用`flutter format`命令格式化代码
- 示例：
  ```bash
  flutter format lib/
  ```

#### 11.2.3 性能优化
- 使用Flutter DevTools分析应用性能
- 定位和修复性能瓶颈
- 示例：
  ```bash
  flutter pub global activate devtools
  flutter pub global run devtools
  ```

---

**文档版本**：v1.0
**创建日期**：2025年12月28日
**审核人**：[待填写]
**批准人**：[待填写]