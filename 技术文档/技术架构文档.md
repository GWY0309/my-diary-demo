# 技术架构文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述了私人日记App - My Diary的技术架构设计，包括系统架构、技术栈选择、模块划分、数据流、安全设计等内容，为开发团队提供技术实现的指导和规范。

### 1.2 文档范围
本文档涵盖了My Diary App的前端架构、后端架构、数据库设计、安全设计、部署架构等方面的技术设计。

### 1.3 术语定义
| 术语 | 定义 |
|------|------|
| Flutter | Google开发的跨平台移动应用开发框架 |
| Dart | Flutter使用的编程语言 |
| Firebase | Google提供的移动和Web应用开发平台 |
| Firestore | Firebase提供的云数据库服务 |
| Firebase Storage | Firebase提供的云存储服务 |
| Firebase Auth | Firebase提供的用户认证服务 |
| SQLite | 轻量级的关系型数据库管理系统 |
| BLoC | Business Logic Component，一种状态管理模式 |
| Provider | Flutter的状态管理库 |
| AES-256 | 高级加密标准，256位密钥长度 |
| HTTPS | 超文本传输安全协议 |

## 2. 系统架构概述

### 2.1 架构设计原则
- **模块化**：将系统划分为独立的模块，降低耦合度
- **可扩展性**：支持功能扩展和技术栈升级
- **安全性**：注重数据安全和隐私保护
- **高性能**：优化应用性能，提供流畅的用户体验
- **可维护性**：代码结构清晰，易于维护和调试

### 2.2 系统架构图

```
┌───────────────────────────────────────────────────────────────────┐
│                           客户端层                                │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                        Flutter App                          │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │  │   UI层      │  │  状态管理层  │  │    业务逻辑层        │  │  │
│  │  │  Widgets    │  │  BLoC/Provider│  │  Services/Repositories│ │ │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  │                                                             │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │  │  数据持久层  │  │  加密模块    │  │    本地存储模块      │  │  │
│  │  │  Hive/SQLite│  │  AES-256    │  │  SharedPreferences  │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────┬───────────────────────────────┘
                                     │ HTTPS/REST API
┌───────────────────────────────────┴───────────────────────────────┐
│                           服务端层                                │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                         Firebase                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │  │  Firebase   │  │  Firestore   │  │  Firebase Storage   │  │  │
│  │  │  Auth       │  │  Database    │  │                     │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  │                                                             │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │  │
│  │  │  Cloud      │  │  Cloud      │  │  Firebase           │  │  │
│  │  │  Functions  │  │  Messaging  │  │  Analytics          │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────┘
```

## 3. 技术栈选择

### 3.1 前端技术栈
| 技术/框架 | 版本 | 用途 |
|----------|------|------|
| Flutter | 3.0+ | 跨平台移动应用开发框架 |
| Dart | 2.17+ | 编程语言 |
| BLoC Pattern | 最新 | 状态管理 |
| Provider | 6.0+ | 状态管理和依赖注入 |
| Hive | 2.0+ | 本地数据持久化 |
| SQLite | 最新 | 本地关系型数据库 |
| path_provider | 最新 | 文件路径管理 |
| flutter_secure_storage | 8.0+ | 安全存储敏感数据 |
| encrypt | 5.0+ | 数据加密 |
| local_auth | 2.0+ | 生物识别认证 |
| image_picker | 0.8+ | 图片选择和拍摄 |
| firebase_core | 1.17+ | Firebase核心服务 |
| firebase_auth | 3.3+ | 用户认证 |
| cloud_firestore | 3.1+ | 云数据库 |
| firebase_storage | 10.2+ | 云存储 |

### 3.2 后端技术栈
| 技术/服务 | 版本 | 用途 |
|----------|------|------|
| Firebase | 最新 | 后端即服务(BaaS) |
| Firebase Auth | 最新 | 用户认证服务 |
| Cloud Firestore | 最新 | 云数据库服务 |
| Firebase Storage | 最新 | 云存储服务 |
| Cloud Functions | 最新 | 云函数服务 |
| Firebase Security Rules | 最新 | 安全规则配置 |

### 3.3 开发工具
| 工具 | 用途 |
|------|------|
| Android Studio | 主要开发环境 |
| VS Code | 辅助开发环境 |
| Flutter DevTools | 调试和性能分析 |
| Firebase Console | 后端服务管理 |
| Postman | API测试 |
| Git | 版本控制 |

## 4. 模块划分

### 4.1 前端模块

#### 4.1.1 核心模块
| 模块名称 | 主要职责 | 文件位置 |
|----------|----------|----------|
| 用户认证模块 | 注册、登录、忘记密码、退出登录 | lib/modules/auth/ |
| 隐私保护模块 | 应用锁、生物识别、数据加密 | lib/modules/security/ |
| 日记管理模块 | 创建、编辑、删除、查看日记 | lib/modules/diary/ |
| 内容编辑模块 | 文字编辑、图片添加、标签管理 | lib/modules/editor/ |
| 数据同步模块 | 云端同步、本地存储、自动备份 | lib/modules/sync/ |
| 搜索统计模块 | 搜索功能、统计分析 | lib/modules/search_stat/ |
| 主题切换模块 | 日间/夜间模式、自定义主题 | lib/modules/theme/ |

#### 4.1.2 基础模块
| 模块名称 | 主要职责 | 文件位置 |
|----------|----------|----------|
| 网络模块 | 处理网络请求和响应 | lib/core/network/ |
| 存储模块 | 本地数据存储和管理 | lib/core/storage/ |
| 加密模块 | 数据加密和解密 | lib/core/security/ |
| 工具模块 | 通用工具函数 | lib/core/utils/ |
| 配置模块 | 应用配置和常量 | lib/core/config/ |

### 4.2 后端模块

#### 4.2.1 Firebase服务
| 服务名称 | 主要职责 |
|----------|----------|
| Firebase Auth | 管理用户账号和认证 |
| Cloud Firestore | 存储和同步用户数据 |
| Firebase Storage | 存储用户上传的图片 |
| Cloud Functions | 处理后端业务逻辑 |
| Firebase Security Rules | 控制数据访问权限 |

## 5. 数据流设计

### 5.1 数据流向图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   用户操作   │────►│   UI层      │────►│  业务逻辑层  │────►│   数据层     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────┬───────┘
                                                                  │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────┴───────┐
│   数据展示   │◄────│   状态管理   │◄────│  业务逻辑层  │◄────│   数据层     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

### 5.2 数据同步流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   本地数据库    │────►│   同步服务      │────►│   云数据库      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       ▲                         ▲                         ▲
       │                         │                         │
       │                         │                         │
       └─────────────────────────┼─────────────────────────┘
                                 │
┌─────────────────┐     ┌────────┴────────┐     ┌─────────────────┐
│   日记编辑操作   │────►│   同步触发器    │────►│   数据变更检测   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 5.3 用户认证流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   登录界面   │────►│   认证服务   │────►│  Firebase   │────►│   本地存储   │
└─────────────┘     └─────────────┘     └─────┬───────┘     └─────────────┘
                                               │
                                               │
┌─────────────┐     ┌─────────────┐     ┌─────┴───────┐     ┌─────────────┐
│   主界面     │◄────│   认证状态   │◄────│   Token管理  │◄────│   会话管理   │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
```

## 6. 安全设计

### 6.1 数据加密

#### 6.1.1 本地数据加密
- 使用AES-256算法加密敏感数据
- 密钥存储在flutter_secure_storage中
- 加密范围包括：
  - 用户密码
  - 应用锁密码
  - 日记内容
  - 标签信息

#### 6.1.2 传输数据加密
- 所有网络请求使用HTTPS协议
- Firebase服务默认使用SSL/TLS加密
- API请求和响应数据加密传输

#### 6.1.3 云端数据加密
- Firebase Storage数据自动加密存储
- Cloud Firestore数据默认加密存储
- 支持客户端加密后再上传

### 6.2 用户认证安全

#### 6.2.1 密码安全
- 密码使用加盐哈希存储
- 密码强度验证（至少8位，包含字母和数字）
- 支持密码重置功能

#### 6.2.2 多因素认证
- 支持生物识别认证（指纹/面容）
- 应用锁保护
- 会话超时管理

### 6.3 访问控制

#### 6.3.1 Firebase安全规则
```rules
// 用户认证规则
service cloud.firestore {
  match /databases/{database}/documents {
    // 只有认证用户可以访问
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
    
    // 用户只能访问自己的数据
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // 日记数据访问控制
    match /diaries/{diaryId} {
      allow read, write: if resource.data.userId == request.auth.uid;
      allow create: if request.resource.data.userId == request.auth.uid;
    }
  }
}
```

#### 6.3.2 权限管理
- 用户只能访问自己的数据
- 管理员权限严格控制
- 操作日志记录

### 6.4 隐私保护
- 遵循GDPR和CCPA隐私法规
- 用户数据最小化收集
- 透明的隐私政策
- 用户数据删除功能

## 7. 性能优化

### 7.1 前端性能优化
- 使用ListView.builder实现列表懒加载
- 图片压缩和缓存
- 状态管理优化，减少不必要的重绘
- 使用async/await优化异步操作
- 避免内存泄漏

### 7.2 后端性能优化
- 数据库索引优化
- 批量操作减少网络请求
- 云函数优化，减少执行时间
- 数据缓存策略

### 7.3 网络优化
- 离线支持，本地缓存数据
- 增量同步，减少数据传输量
- 网络状态监听，优化网络请求
- 重试机制，提高请求成功率

## 8. 扩展性设计

### 8.1 功能扩展性
- 模块化设计，支持功能插件化
- 预留API接口，方便功能扩展
- 支持第三方服务集成

### 8.2 技术扩展性
- 分层架构，便于技术栈升级
- 依赖注入，降低组件耦合度
- 接口抽象，支持多实现

### 8.3 业务扩展性
- 支持多语言和国际化
- 支持主题定制
- 支持不同地区的合规要求

## 9. 部署架构

### 9.1 应用部署
- Google Play Store：Android应用发布
- Apple App Store：iOS应用发布
- 应用签名和打包：使用Android Studio

### 9.2 后端部署
- Firebase服务：自动部署和扩展
- Cloud Functions：通过Firebase Console或CLI部署
- 安全规则：通过Firebase Console配置

### 9.3 持续集成和持续部署
- CI/CD工具：GitHub Actions或Bitrise
- 自动化测试：单元测试、集成测试
- 自动化构建和部署：代码提交后自动构建和测试

## 10. 监控和日志

### 10.1 前端监控
- Firebase Analytics：用户行为分析
- Crashlytics：崩溃报告和分析
- Performance Monitoring：性能监控

### 10.2 后端监控
- Firebase Console：服务状态监控
- Cloud Functions日志：函数执行日志
- Firestore监控：数据库性能监控

### 10.3 日志系统
- 应用日志：关键操作和错误日志
- 网络日志：API请求和响应日志
- 安全日志：认证和授权日志

## 11. 技术风险评估

| 风险 | 影响程度 | 可能性 | 缓解措施 |
|------|----------|--------|----------|
| Flutter版本兼容性问题 | 中 | 低 | 锁定Flutter版本，定期测试兼容性 |
| Firebase服务中断 | 高 | 低 | 实现离线支持，本地缓存数据 |
| 数据同步冲突 | 中 | 中 | 实现冲突检测和解决机制 |
| 生物识别功能差异 | 中 | 中 | 提供密码锁作为备选方案，充分测试不同设备 |
| 性能问题 | 中 | 中 | 优化代码，定期进行性能测试 |

## 12. 附录

### 12.1 代码结构

```
lib/
├── core/
│   ├── config/          # 应用配置和常量
│   ├── network/         # 网络模块
│   ├── security/        # 安全和加密模块
│   ├── storage/         # 存储模块
│   └── utils/           # 工具函数
├── modules/
│   ├── auth/            # 用户认证模块
│   ├── diary/           # 日记管理模块
│   ├── editor/          # 内容编辑模块
│   ├── search_stat/     # 搜索和统计模块
│   ├── security/        # 隐私保护模块
│   ├── sync/            # 数据同步模块
│   └── theme/           # 主题切换模块
├── presentation/
│   ├── pages/           # 页面组件
│   ├── widgets/         # 通用组件
│   ├── blocs/           # BLoC状态管理
│   └── providers/       # Provider状态管理
└── main.dart            # 应用入口
```

### 12.2 依赖关系图

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   UI层      │◄────┤  状态管理层  │◄────┤  业务逻辑层  │
└─────────────┘     └─────────────┘     └─────┬───────┘
                                              │
┌─────────────┐     ┌─────────────┐     ┌─────┴───────┐
│   工具模块   │◄────┤  网络模块    │◄────┤  数据层     │
└─────────────┘     └─────────────┘     └─────────────┘
```

---

**文档版本**：v1.0
**创建日期**：2025年12月28日
**审核人**：[待填写]
**批准人**：[待填写]