# 数据库设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述了私人日记App - My Diary的数据库设计，包括本地数据库(SQLite/Hive)和云数据库(Firestore)的结构设计、表/集合定义、字段类型、关系、索引等内容，为开发团队提供数据库实现的指导和规范。

### 1.2 文档范围
本文档涵盖了My Diary App的用户数据、日记数据、标签数据等核心数据的存储设计，包括本地存储和云端存储方案。

### 1.3 术语定义
| 术语 | 定义 |
|------|------|
| SQLite | 轻量级的关系型数据库管理系统 |
| Hive | Flutter的NoSQL本地数据库 |
| Firestore | Firebase提供的云数据库服务 |
| 文档 | Firestore中的数据存储单位，类似于关系型数据库中的行 |
| 集合 | Firestore中的数据存储容器，类似于关系型数据库中的表 |
| 字段 | 数据的基本存储单位，类似于关系型数据库中的列 |
| 索引 | 用于加速数据查询的数据结构 |
| AES-256 | 高级加密标准，256位密钥长度 |

## 2. 数据库设计原则

### 2.1 设计原则
- **数据安全性**：敏感数据加密存储
- **数据完整性**：保证数据的准确性和一致性
- **性能优化**：查询优化，减少响应时间
- **可扩展性**：支持未来功能扩展
- **数据一致性**：本地和云端数据保持同步
- **离线支持**：无网络情况下仍能正常使用

### 2.2 数据库选择
| 数据库类型 | 技术选型 | 用途 |
|------------|----------|------|
| 本地关系型数据库 | SQLite | 存储结构化数据，如用户信息、日记内容等 |
| 本地NoSQL数据库 | Hive | 存储非结构化数据，如用户偏好设置、临时数据等 |
| 云数据库 | Firestore | 存储用户数据备份，支持多设备同步 |

## 3. 本地数据库设计

### 3.1 SQLite数据库设计

#### 3.1.1 数据库概览
- 数据库名称：`my_diary.db`
- 版本：1.0
- 加密方式：AES-256加密整个数据库

#### 3.1.2 表结构设计

##### 3.1.2.1 用户表(users)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户ID |
| uid | TEXT | UNIQUE NOT NULL | Firebase用户ID |
| email | TEXT | UNIQUE NOT NULL | 邮箱地址 |
| password_hash | TEXT | NOT NULL | 密码哈希值 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| last_sync_at | TIMESTAMP | NULL | 最后同步时间 |
| app_lock_enabled | INTEGER | NOT NULL DEFAULT 0 | 应用锁是否启用(0:否, 1:是) |
| app_lock_type | INTEGER | NULL | 应用锁类型(0:密码, 1:生物识别) |
| app_lock_password | TEXT | NULL | 应用锁密码(加密存储) |
| theme_type | INTEGER | NOT NULL DEFAULT 0 | 主题类型(0:系统, 1:日间, 2:夜间) |

##### 3.1.2.2 日记表(diaries)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 日记ID |
| user_id | INTEGER | NOT NULL REFERENCES users(id) | 用户ID |
| cloud_id | TEXT | NULL | 云端日记ID |
| title | TEXT | NOT NULL | 日记标题 |
| content | TEXT | NOT NULL | 日记内容(加密存储) |
| mood | INTEGER | NULL | 心情(0-4:很差到很好) |
| weather | INTEGER | NULL | 天气(0-7:晴、多云、阴、雨、雪、雾、雷、风) |
| location | TEXT | NULL | 位置信息 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| is_deleted | INTEGER | NOT NULL DEFAULT 0 | 是否删除(0:否, 1:是) |
| sync_status | INTEGER | NOT NULL DEFAULT 0 | 同步状态(0:未同步, 1:已同步, 2:同步中, 3:同步失败) |

##### 3.1.2.3 标签表(tags)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 标签ID |
| user_id | INTEGER | NOT NULL REFERENCES users(id) | 用户ID |
| cloud_id | TEXT | NULL | 云端标签ID |
| name | TEXT | NOT NULL | 标签名称 |
| color | TEXT | NOT NULL DEFAULT '#3F51B5' | 标签颜色 |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| is_deleted | INTEGER | NOT NULL DEFAULT 0 | 是否删除(0:否, 1:是) |
| sync_status | INTEGER | NOT NULL DEFAULT 0 | 同步状态(0:未同步, 1:已同步, 2:同步中, 3:同步失败) |

##### 3.1.2.4 日记标签关联表(diary_tags)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 关联ID |
| diary_id | INTEGER | NOT NULL REFERENCES diaries(id) | 日记ID |
| tag_id | INTEGER | NOT NULL REFERENCES tags(id) | 标签ID |
| UNIQUE(diary_id, tag_id) | | | 唯一约束，确保一个日记不能重复关联同一个标签 |

##### 3.1.2.5 图片表(images)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 图片ID |
| diary_id | INTEGER | NOT NULL REFERENCES diaries(id) | 日记ID |
| cloud_path | TEXT | NULL | 云端存储路径 |
| local_path | TEXT | NOT NULL | 本地存储路径 |
| file_name | TEXT | NOT NULL | 文件名 |
| file_size | INTEGER | NOT NULL | 文件大小(字节) |
| created_at | TIMESTAMP | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| sync_status | INTEGER | NOT NULL DEFAULT 0 | 同步状态(0:未同步, 1:已同步, 2:同步中, 3:同步失败) |

#### 3.1.3 索引设计
| 表名 | 索引字段 | 索引类型 | 用途 |
|------|----------|----------|------|
| users | uid | UNIQUE | 加速通过uid查询用户 |
| users | email | UNIQUE | 加速通过email查询用户 |
| diaries | user_id, created_at | INDEX | 加速按用户ID和创建时间查询日记 |
| diaries | user_id, is_deleted | INDEX | 加速查询用户的有效日记 |
| tags | user_id, name | INDEX | 加速按用户ID和名称查询标签 |
| diary_tags | diary_id | INDEX | 加速查询日记关联的标签 |
| diary_tags | tag_id | INDEX | 加速查询标签关联的日记 |
| images | diary_id | INDEX | 加速查询日记关联的图片 |

#### 3.1.4 视图设计

##### 3.1.4.1 日记详情视图(v_diary_detail)
```sql
CREATE VIEW v_diary_detail AS
SELECT 
    d.id, d.user_id, d.title, d.content, d.mood, d.weather, d.location, 
    d.created_at, d.updated_at, 
    GROUP_CONCAT(t.name, ', ') AS tags
FROM diaries d
LEFT JOIN diary_tags dt ON d.id = dt.diary_id
LEFT JOIN tags t ON dt.tag_id = t.id
WHERE d.is_deleted = 0 AND t.is_deleted = 0
GROUP BY d.id;
```

### 3.2 Hive数据库设计

#### 3.2.1 数据库概览
- 数据库位置：应用私有目录下的hive文件夹
- 加密方式：AES-256加密敏感数据
- 数据格式：键值对存储

#### 3.2.2 Box设计

##### 3.2.2.1 用户偏好设置(preferences)
| 键 | 值类型 | 描述 |
|----|--------|------|
| theme_type | int | 主题类型(0:系统, 1:日间, 2:夜间) |
| font_size | int | 字体大小(0:小, 1:中, 2:大) |
| default_mood | int | 默认心情 |
| default_weather | int | 默认天气 |
| enable_notifications | bool | 是否启用通知 |
| notification_time | TimeOfDay | 通知时间 |
| enable_auto_backup | bool | 是否启用自动备份 |
| backup_frequency | int | 备份频率(0:每天, 1:每周, 2:每月) |
| last_backup_time | DateTime | 最后备份时间 |
| intro_completed | bool | 是否完成首次使用引导 |

##### 3.2.2.2 应用状态(app_state)
| 键 | 值类型 | 描述 |
|----|--------|------|
| is_logged_in | bool | 是否已登录 |
| current_user_id | String | 当前登录用户ID |
| last_active_time | DateTime | 最后活跃时间 |
| sync_in_progress | bool | 是否正在同步 |
| pending_sync_count | int | 待同步数据数量 |

##### 3.2.2.3 搜索历史(search_history)
| 键 | 值类型 | 描述 |
|----|--------|------|
| query | String | 搜索关键词 |
| timestamp | DateTime | 搜索时间 |
| count | int | 搜索次数 |

## 4. 云数据库设计

### 4.1 Firestore数据库设计

#### 4.1.1 数据库概览
- 数据库类型：文档型NoSQL数据库
- 数据结构：集合(Collection) → 文档(Document) → 字段(Field)
- 安全规则：基于Firebase Security Rules进行访问控制
- 加密方式：传输加密(HTTPS)和存储加密

#### 4.1.2 集合结构设计

##### 4.1.2.1 用户集合(users)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| email | string | REQUIRED | 邮箱地址 |
| created_at | timestamp | REQUIRED | 创建时间 |
| updated_at | timestamp | REQUIRED | 更新时间 |
| last_login_at | timestamp | REQUIRED | 最后登录时间 |
| app_lock_enabled | boolean | REQUIRED | 应用锁是否启用 |
| app_lock_type | number | OPTIONAL | 应用锁类型(0:密码, 1:生物识别) |
| theme_type | number | REQUIRED | 主题类型(0:系统, 1:日间, 2:夜间) |
| settings | map | REQUIRED | 用户偏好设置 |
| devices | array | REQUIRED | 已登录设备列表 |

示例文档：
```json
{
  "email": "user@example.com",
  "created_at": "2025-12-01T10:00:00Z",
  "updated_at": "2025-12-28T15:30:00Z",
  "last_login_at": "2025-12-28T15:30:00Z",
  "app_lock_enabled": true,
  "app_lock_type": 1,
  "theme_type": 1,
  "settings": {
    "font_size": 1,
    "enable_notifications": true,
    "notification_time": "08:00",
    "enable_auto_backup": true
  },
  "devices": [
    {
      "device_id": "device123",
      "device_name": "My Phone",
      "last_active_at": "2025-12-28T15:30:00Z"
    }
  ]
}
```

##### 4.1.2.2 日记集合(diaries)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| user_id | string | REQUIRED | 用户ID |
| title | string | REQUIRED | 日记标题 |
| content | string | REQUIRED | 日记内容(加密存储) |
| mood | number | OPTIONAL | 心情(0-4:很差到很好) |
| weather | number | OPTIONAL | 天气(0-7:晴、多云、阴、雨、雪、雾、雷、风) |
| location | string | OPTIONAL | 位置信息 |
| tags | array | REQUIRED | 标签ID列表 |
| images | array | REQUIRED | 图片云存储路径列表 |
| created_at | timestamp | REQUIRED | 创建时间 |
| updated_at | timestamp | REQUIRED | 更新时间 |
| is_deleted | boolean | REQUIRED | 是否删除 |

示例文档：
```json
{
  "user_id": "user123",
  "title": "今天的心情",
  "content": "U2FsdGVkX1+...(加密后的内容)",
  "mood": 3,
  "weather": 0,
  "location": "北京市",
  "tags": ["tag1", "tag2"],
  "images": ["images/user123/diary1/image1.jpg"],
  "created_at": "2025-12-28T10:00:00Z",
  "updated_at": "2025-12-28T10:00:00Z",
  "is_deleted": false
}
```

##### 4.1.2.3 标签集合(tags)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| user_id | string | REQUIRED | 用户ID |
| name | string | REQUIRED | 标签名称 |
| color | string | REQUIRED | 标签颜色 |
| created_at | timestamp | REQUIRED | 创建时间 |
| updated_at | timestamp | REQUIRED | 更新时间 |
| is_deleted | boolean | REQUIRED | 是否删除 |

示例文档：
```json
{
  "user_id": "user123",
  "name": "工作",
  "color": "#3F51B5",
  "created_at": "2025-12-01T10:00:00Z",
  "updated_at": "2025-12-01T10:00:00Z",
  "is_deleted": false
}
```

##### 4.1.2.4 备份集合(backups)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| user_id | string | REQUIRED | 用户ID |
| backup_time | timestamp | REQUIRED | 备份时间 |
| backup_size | number | REQUIRED | 备份大小(字节) |
| diary_count | number | REQUIRED | 日记数量 |
| image_count | number | REQUIRED | 图片数量 |
| status | string | REQUIRED | 备份状态("completed", "failed", "in_progress") |
| device_info | map | REQUIRED | 备份设备信息 |

示例文档：
```json
{
  "user_id": "user123",
  "backup_time": "2025-12-28T12:00:00Z",
  "backup_size": 1024000,
  "diary_count": 100,
  "image_count": 50,
  "status": "completed",
  "device_info": {
    "device_id": "device123",
    "device_name": "My Phone",
    "os_version": "Android 12"
  }
}
```

#### 4.1.3 安全规则设计
```rules
// Firestore安全规则
service cloud.firestore {
  match /databases/{database}/documents {
    // 用户认证规则
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // 验证用户是否有权限访问数据
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // 用户集合规则
    match /users/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // 日记集合规则
    match /diaries/{diaryId} {
      allow read, write: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
    }
    
    // 标签集合规则
    match /tags/{tagId} {
      allow read, write: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
    }
    
    // 备份集合规则
    match /backups/{backupId} {
      allow read, write: if isAuthenticated() && resource.data.user_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.user_id == request.auth.uid;
    }
  }
}
```

## 4. 数据同步策略

### 4.1 同步原则
- **双向同步**：本地数据变更同步到云端，云端数据变更同步到本地
- **增量同步**：仅同步变更的数据，减少数据传输量
- **冲突解决**：最后更新时间为准，保留最新数据
- **离线支持**：离线时数据存储在本地，联网后自动同步
- **批量操作**：合并多个小的同步请求，减少网络请求次数

### 4.2 同步流程

#### 4.2.1 本地到云端同步流程
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   本地数据变更   │────►│   变更检测      │────►│   数据加密      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       ▲                         ▲                         ▲
       │                         │                         │
       │                         │                         │
       └─────────────────────────┼─────────────────────────┘
                                 │
┌─────────────────┐     ┌────────┴────────┐     ┌─────────────────┐
│   云端数据更新   │◄────│   数据同步      │◄────│   网络请求      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

#### 4.2.2 云端到本地同步流程
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   云端数据变更   │────►│   推送通知      │────►│   数据拉取      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       ▲                         ▲                         ▲
       │                         │                         │
       │                         │                         │
       └─────────────────────────┼─────────────────────────┘
                                 │
┌─────────────────┐     ┌────────┴────────┐     ┌─────────────────┐
│   本地数据更新   │◄────│   数据解密      │◄────│   数据处理      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

### 4.3 同步触发时机
- 应用启动时
- 数据变更时(创建、编辑、删除)
- 应用从后台切换到前台时
- 定时自动同步(默认每小时)
- 用户手动触发同步

## 5. 数据库安全设计

### 5.1 数据加密

#### 5.1.1 本地数据加密
- **SQLite数据库**：使用sqflite_sqlcipher库对整个数据库进行AES-256加密
- **Hive数据库**：敏感数据字段使用encrypt库进行AES-256加密
- **密钥管理**：使用flutter_secure_storage库安全存储加密密钥

#### 5.1.2 云端数据加密
- **传输加密**：所有网络请求使用HTTPS协议
- **存储加密**：Firebase自动对存储在云端的数据进行加密
- **敏感数据加密**：日记内容等敏感数据在本地加密后再上传到云端

### 5.2 访问控制
- **本地访问控制**：应用锁和生物识别认证
- **云端访问控制**：Firebase安全规则，用户只能访问自己的数据
- **权限管理**：最小权限原则，只授予必要的权限

### 5.3 数据备份与恢复
- **自动备份**：定期自动备份数据到云端
- **手动备份**：支持用户手动备份数据
- **数据恢复**：支持从云端备份恢复数据
- **恢复点**：保留最近7天的备份，支持选择恢复点

## 6. 性能优化

### 6.1 本地数据库性能优化
- **索引优化**：为常用查询字段创建索引
- **批量操作**：使用事务处理批量操作
- **查询优化**：避免全表扫描，使用索引查询
- **数据分页**：分页加载大量数据
- **缓存策略**：缓存常用数据，减少数据库查询

### 6.2 云数据库性能优化
- **索引优化**：为常用查询字段创建复合索引
- **数据结构优化**：扁平化数据结构，减少嵌套层级
- **查询优化**：限制查询结果数量，使用where子句过滤数据
- **数据分区**：按用户ID分区存储数据
- **缓存策略**：使用Firestore的离线缓存功能

### 6.3 同步性能优化
- **增量同步**：仅同步变更的数据
- **批量同步**：合并多个小的同步请求
- **网络优化**：根据网络状态调整同步策略
- **优先级控制**：重要数据优先同步

## 7. 数据库迁移策略

### 7.1 SQLite数据库迁移
- **版本控制**：使用数据库版本号管理 schema 变更
- **迁移脚本**：为每个版本变更编写迁移脚本
- **向前兼容**：新版本支持旧版本的数据格式
- **回滚机制**：迁移失败时能够回滚到之前的版本

示例迁移脚本：
```dart
// 版本1到版本2的迁移脚本
Future<void> _onUpgrade(Database db, int oldVersion, int newVersion) async {
  if (oldVersion < 2) {
    // 添加新字段
    await db.execute('ALTER TABLE diaries ADD COLUMN location TEXT');
    // 创建新表
    await db.execute('CREATE TABLE images (...)');
  }
}
```

### 7.2 Hive数据库迁移
- **Box版本控制**：使用Box的版本号管理数据结构变更
- **迁移回调**：实现onUpgrade回调处理数据迁移
- **数据转换**：将旧版本的数据转换为新版本的格式

### 7.3 云端数据库迁移
- **向后兼容**：新版本应用支持旧版本的云端数据格式
- **渐进式迁移**：逐步迁移云端数据到新格式
- **数据验证**：迁移后验证数据完整性

## 8. 附录

### 8.1 数据类型映射

#### 8.1.1 SQLite到Dart数据类型映射
| SQLite数据类型 | Dart数据类型 |
|---------------|--------------|
| INTEGER | int |
| TEXT | String |
| REAL | double |
| BLOB | Uint8List |
| NULL | null |
| TIMESTAMP | DateTime |

#### 8.1.2 Hive到Dart数据类型映射
| Hive数据类型 | Dart数据类型 |
|--------------|--------------|
| int | int |
| string | String |
| double | double |
| bool | bool |
| List | List |
| Map | Map |
| DateTime | DateTime |
| Uint8List | Uint8List |

#### 8.1.3 Firestore到Dart数据类型映射
| Firestore数据类型 | Dart数据类型 |
|------------------|--------------|
| number | int/double |
| string | String |
| boolean | bool |
| array | List |
| map | Map |
| timestamp | DateTime |
| geopoint | GeoPoint |
| reference | DocumentReference |
| blob | Uint8List |

### 8.2 加密算法
- **对称加密**：AES-256 CBC模式
- **密钥派生**：PBKDF2，10000轮迭代
- **初始化向量**：随机生成，与密文一起存储
- **认证标签**：HMAC-SHA256，用于验证数据完整性

---

**文档版本**：v1.0
**创建日期**：2025年12月28日
**审核人**：[待填写]
**批准人**：[待填写]